<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Curso | Gonzalo Juárez López Jr.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Playfair+Display:wght@700&display=swap"
        rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brandPink: '#ec4899',
                        brandPinkHover: '#db2777',
                        bgDark: '#0a0a0a',
                        cardDark: '#171717',
                        borderDark: '#262626'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #000;
            color: #fff;
            -webkit-user-select: none;
            /* Safari */
            -ms-user-select: none;
            /* IE 10 and IE 11 */
            user-select: none;
            /* Standard syntax */
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        /* Anti-Piracy Overlay for Video */
        .video-protection-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            background: transparent;
            /* Allow clicks to pass through to start video if needed, 
               but catch context menu. 
               Note: pointer-events: none would let clicks pass but ALSO right clicks. 
               We need something clever or accept we can't fully block iframe right click.
            */
            pointer-events: none;
        }
    </style>
    <script>
        // Anti-Piracy Script
        document.addEventListener('contextmenu', event => event.preventDefault());

        document.addEventListener('keydown', function (e) {
            // Block F12, Ctrl+Shift+I (DevTools)
            if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I')) {
                e.preventDefault();
            }
            // Block PrintScreen (Instructional - can't fully block OS)
            if (e.key === 'PrintScreen') {
                // Try to clear clipboard or blur body
                navigator.clipboard.writeText('');
                alert('Las capturas de pantalla no están permitidas en esta plataforma.');
            }
            // Block Ctrl+S (Save)
            if (e.ctrlKey && (e.key === 's' || e.key === 'S')) {
                e.preventDefault();
            }
            // Block Ctrl+U (View Source)
            if (e.ctrlKey && (e.key === 'u' || e.key === 'U')) {
                e.preventDefault();
            }
        });
    </script>
</head>

<body x-data="courseViewer()" x-init="init()" class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="h-[70px] border-b border-borderDark flex items-center justify-between px-6 bg-bgDark z-20">
        <div class="flex items-center gap-4">
            <a href="panel.html"
                class="p-2 hover:bg-white/5 rounded-full transition-colors text-zinc-400 hover:text-white">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7" />
                </svg>
            </a>
            <h1 class="font-semibold text-sm sm:text-base truncate max-w-[200px] sm:max-w-md"
                x-text="course ? course.title : 'Cargando...'"></h1>
        </div>
        <div class="flex items-center gap-4">
            <div class="hidden sm:block text-xs text-zinc-400">
                Progreso: <span class="text-white font-medium" x-text="progress + '%'"></span>
            </div>
            <div class="w-32 h-2 bg-zinc-800 rounded-full overflow-hidden">
                <div class="h-full bg-brandPink transition-all duration-500" :style="'width: ' + progress + '%'"></div>
            </div>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden">

        <!-- Main Content (Video) -->
        <main class="flex-1 flex flex-col overflow-y-auto bg-black relative">
            <div class="flex-1 flex items-center justify-center bg-black relative group">
                <template x-if="currentLesson">
                    <div class="w-full h-full relative" oncontextmenu="return false;">
                        <!-- Protection Overlay -->
                        <div class="video-protection-overlay"></div>

                        <!-- Case 1: Raw Iframe Code pasted by user -->
                        <div x-show="isIframe(currentLesson.url)" x-html="currentLesson.url"
                            class="w-full h-full absolute inset-0 [&>iframe]:w-full [&>iframe]:h-full border-none">
                        </div>

                        <!-- Case 2: URL to be converted to Embed -->
                        <iframe x-show="!isIframe(currentLesson.url) && currentLesson.url"
                            :src="getEmbedUrl(currentLesson.url)" class="w-full h-full absolute inset-0" frameborder="0"
                            allow="autoplay; fullscreen" allowfullscreen>
                        </iframe>

                        <!-- Fallback if no video -->
                        <div x-show="!currentLesson.url"
                            class="w-full h-full flex flex-col items-center justify-center text-zinc-500 gap-4">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="1">
                                <circle cx="12" cy="12" r="10" />
                                <polygon points="10 8 16 12 10 16 10 8" />
                            </svg>
                            <p>Esta lección no tiene video disponible</p>
                        </div>
                    </div>
                </template>
                <template x-if="!currentLesson">
                    <div class="w-full h-full flex flex-col items-center justify-center text-zinc-500 gap-4">
                        <p>Selecciona una lección</p>
                    </div>
                </template>
            </div>

            <!-- Content Info -->
            <div class="p-8 max-w-4xl mx-auto w-full space-y-6">
                <div class="flex items-start justify-between">
                    <div>
                        <h2 class="text-2xl font-bold mb-2" x-text="currentLesson ? currentLesson.title : 'Bienvenido'">
                        </h2>
                        <p class="text-zinc-400 text-sm" x-text="currentModuleTitle || ''"></p>
                    </div>
                    <button @click="markCompleted()" x-show="currentLesson"
                        class="px-4 py-2 rounded-lg text-xs font-semibold flex items-center gap-2 transition-colors border"
                        :class="isCompleted(currentLesson?.id) ? 'bg-green-500/10 text-green-500 border-green-500/50' : 'bg-white text-black hover:bg-zinc-200 border-transparent'">
                        <svg x-show="isCompleted(currentLesson?.id)" width="16" height="16" viewBox="0 0 24 24"
                            fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12" />
                        </svg>
                        <span x-text="isCompleted(currentLesson?.id) ? 'Completado' : 'Marcar como visto'"></span>
                    </button>
                </div>

                <!-- Resources Tab -->
                <div class="pt-6 border-t border-zinc-800">
                    <h3 class="font-semibold mb-4 text-sm">Recursos de la lección</h3>
                    <div class="grid gap-3">
                        <template x-if="currentLesson && currentLesson.resources && currentLesson.resources.length > 0">
                            <template x-for="res in currentLesson.resources">
                                <a :href="res.url" target="_blank"
                                    class="flex items-center gap-3 p-3 rounded-lg border border-borderDark bg-cardDark hover:bg-white/5 transition-colors group">
                                    <div
                                        class="p-2 bg-zinc-800 rounded text-zinc-400 group-hover:text-white transition-colors">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2">
                                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                                            <polyline points="14 2 14 8 20 8" />
                                            <line x1="12" y1="18" x2="12" y2="12" />
                                            <line x1="9" y1="15" x2="15" y2="15" />
                                        </svg>
                                    </div>
                                    <div>
                                        <div class="text-sm font-medium" x-text="res.name || 'Recurso descargable'">
                                        </div>
                                        <div class="text-[10px] text-zinc-500">Click para descargar</div>
                                    </div>
                                </a>
                            </template>
                        </template>
                        <div x-show="!currentLesson || !currentLesson.resources || currentLesson.resources.length === 0"
                            class="text-zinc-500 text-sm">
                            No hay recursos adjuntos a esta lección.
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Sidebar Playlist -->
        <aside class="w-80 bg-bgDark border-l border-borderDark flex flex-col z-10 hidden lg:flex">
            <div class="p-4 border-b border-borderDark">
                <h3 class="font-semibold text-sm">Contenido del Curso</h3>
                <p class="text-[10px] text-zinc-400 mt-1" x-text="(totalLessons) + ' lecciones'"></p>
            </div>

            <div class="flex-1 overflow-y-auto">
                <template x-for="(module, mIndex) in (course?.modules || [])" :key="module.id || mIndex">
                    <div>
                        <div class="px-4 py-2 bg-zinc-900/50 text-[10px] font-bold text-zinc-500 uppercase tracking-wider border-b border-borderDark/50"
                            x-text="module.title"></div>

                        <template x-for="(lesson, lIndex) in (module.lessons || [])" :key="lesson.id || lIndex">
                            <button @click="loadLesson(lesson, module.title)"
                                class="w-full text-left p-4 hover:bg-white/5 transition-colors border-b border-zinc-900 group relative"
                                :class="currentLesson === lesson ? 'bg-white/10' : ''">
                                <div class="flex items-start gap-3">
                                    <div class="mt-0.5">
                                        <div class="w-5 h-5 rounded-full border border-zinc-600 flex items-center justify-center text-[10px] text-zinc-500"
                                            :class="isCompleted(lesson.id) ? 'bg-green-500 border-green-500 text-black' : ''">
                                            <svg x-show="isCompleted(lesson.id)" width="12" height="12"
                                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                                <polyline points="20 6 9 17 4 12" />
                                            </svg>
                                            <span x-show="!isCompleted(lesson.id)" x-text="lIndex + 1"></span>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 class="text-xs font-medium group-hover:text-brandPink transition-colors"
                                            x-text="lesson.title"></h4>
                                        <div class="flex items-center gap-2 mt-1">
                                            <span class="text-[10px] text-zinc-500">Video</span>
                                        </div>
                                    </div>
                                </div>
                            </button>
                        </template>
                    </div>
                </template>
            </div>
        </aside>

    </div>

    <!-- Mobile Module List Drawer (Optional) -->

    <script src="./api.js"></script>
    <script>
        function courseViewer() {
            return {
                course: null,
                currentLesson: null,
                currentModuleTitle: '',
                progress: 0,
                completedModules: [], // This actually stores LESSON IDs (renaming it would be better but keeping for compat)
                totalLessons: 0,

                async init() {
                    const params = new URLSearchParams(window.location.search);
                    const courseId = params.get('id');
                    if (!courseId) {
                        alert('Curso no especificado');
                        window.location.href = 'panel.html';
                        return;
                    }

                    try {
                        let courseFound = null;

                        // Try Loading My Courses first
                        try {
                            const myCourses = await window.API.apiGetMyPurchasedCourses();
                            const purchased = myCourses.courses.find(c => c.id == courseId);
                            if (purchased) {
                                courseFound = purchased;
                                this.completedModules = purchased.completedLessons || [];
                                this.progress = purchased.progress || 0;
                            }
                        } catch (ignore) { }

                        if (!courseFound) {
                            const allCourses = await window.API.apiGetProducts();
                            courseFound = allCourses.find(c => c.id == courseId);
                        }

                        this.course = courseFound;

                        // Calculate totals and select first lesson
                        if (this.course && this.course.modules) {
                            let first = true;
                            let count = 0;
                            this.course.modules.forEach(m => {
                                if (m.lessons && m.lessons.length > 0) {
                                    count += m.lessons.length;
                                    if (first) {
                                        this.loadLesson(m.lessons[0], m.title);
                                        first = false;
                                    }
                                }
                            });
                            this.totalLessons = count;
                        }

                    } catch (e) {
                        console.error("Error loading course", e);
                    }
                },

                loadLesson(lesson, modTitle) {
                    this.currentLesson = lesson;
                    this.currentModuleTitle = modTitle;
                },

                isCompleted(lessonId) {
                    return this.completedModules.includes(lessonId);
                },

                async markCompleted() {
                    if (!this.currentLesson) return;
                    if (!this.completedModules.includes(this.currentLesson.id)) {
                        this.completedModules.push(this.currentLesson.id);
                        this.calculateProgress();

                        try {
                            // Saving progress
                            await window.API.apiUpdateProgress(this.course.id, this.progress, 0.5, this.completedModules);
                        } catch (e) {
                            console.error("Error saving progress", e);
                        }
                    }
                },

                calculateProgress() {
                    if (this.totalLessons === 0) return;
                    this.progress = Math.round((this.completedModules.length / this.totalLessons) * 100);
                },

                isIframe(url) {
                    if (!url) return false;
                    return url.trim().startsWith('<iframe');
                },

                getEmbedUrl(url) {
                    if (!url) return '';
                    if (this.isIframe(url)) return ''; // Handled by x-html

                    // Robust YouTube Regex
                    const ytPattern = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
                    const ytMatch = url.match(ytPattern);
                    if (ytMatch) {
                        // Added modest branding and autoplay
                        return `https://www.youtube.com/embed/${ytMatch[1]}?rel=0`;
                    }

                    // Vimeo Regex
                    const vimeoPattern = /vimeo\.com\/(?:channels\/(?:\w+\/)?|groups\/(?:[^\/]*)\/videos\/|album\/(?:\d+)\/video\/|video\/|)(\d+)(?:$|\/|\?)/;
                    const vimeoMatch = url.match(vimeoPattern);
                    if (vimeoMatch) {
                        return `https://player.vimeo.com/video/${vimeoMatch[1]}`;
                    }

                    return url;
                }
            }
        }
    </script>
</body>

</html>